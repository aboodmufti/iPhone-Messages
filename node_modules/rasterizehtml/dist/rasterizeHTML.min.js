/*! rasterizeHTML.js - v1.1.0 - 2015-03-26
* http://www.github.com/cburgmer/rasterizeHTML.js
* Copyright (c) 2015 Christoph Burgmer; Licensed MIT */
!function(a,b){"function"==typeof define&&define.amd?define(["url","cssMediaQuery","xmlserializer","ayepromise","inlineresources"],function(c,d,e,f,g){return a.rasterizeHTML=b(c,d,e,f,g)}):"object"==typeof exports?module.exports=b(require("url"),require("css-mediaquery"),require("xmlserializer"),require("ayepromise"),require("inlineresources")):a.rasterizeHTML=b(url,cssMediaQuery,xmlserializer,ayepromise,inlineresources)}(this,function(a,b,c,d,e){var f=function(a){"use strict";var b={},c=[];b.joinUrl=function(b,c){return b?a.resolve(b,c):c},b.getConstantUniqueIdFor=function(a){return c.indexOf(a)<0&&c.push(a),c.indexOf(a)},b.clone=function(a){var b,c={};for(b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c};var d=function(a){return"object"==typeof a&&null!==a},e=function(a){return d(a)&&Object.prototype.toString.apply(a).match(/\[object (Canvas|HTMLCanvasElement)\]/i)};return b.parseOptionalParameters=function(a){var c={canvas:null,options:{}};return null==a[0]||e(a[0])?(c.canvas=a[0]||null,c.options=b.clone(a[1])):c.options=b.clone(a[0]),c},b}(a),g=function(a,b){"use strict";var c={},d=function(a,b,c){var d=a[b];return a[b]=function(){var a=Array.prototype.slice.call(arguments);return c.apply(this,[a,d])},d};return c.baseUrlRespectingXhr=function(b,c){var e=function(){var e=new b;return d(e,"open",function(b,d){var e=b.shift(),f=b.shift(),g=a.joinUrl(c,f);return d.apply(this,[e,g].concat(b))}),e};return e},c.finishNotifyingXhr=function(a){var c=0,e=0,f=!1,g=b.defer(),h=function(){var a=c-e;0>=a&&f&&g.resolve({totalCount:c})},i=function(){var b=new a;return d(b,"send",function(a,b){return c+=1,b.apply(this,arguments)}),b.addEventListener("load",function(){e+=1,h()}),b};return i.waitForRequestsToFinish=function(){return f=!0,h(),g.promise},i},c}(f,d),h=function(){"use strict";var a={},b=function(a){return Array.prototype.slice.call(a)};a.addClassNameRecursively=function(b,c){b.className+=" "+c,b.parentNode!==b.ownerDocument&&a.addClassNameRecursively(b.parentNode,c)};var c=function(a,c){var d=a.parentStyleSheet,e=b(d.cssRules).indexOf(a);d.insertRule(c,e+1),d.deleteRule(e)},d=function(a,b){var d=a.cssText.replace(/^[^\{]+/,""),e=b+" "+d;c(a,e)},e=function(a){return b(a).reduce(function(a,b){return a+b.cssText},"")},f=function(a){a.textContent=e(a.sheet.cssRules)},g=function(a){return"((?:^|[^.#:\\w])|(?=\\W))("+a.join("|")+")(?=\\W|$)"},h=function(a,c,e){var h=g(c);b(a.querySelectorAll("style")).forEach(function(a){var c=b(a.sheet.cssRules).filter(function(a){return a.selectorText&&new RegExp(h,"i").test(a.selectorText)});c.length&&(c.forEach(function(a){var b=a.selectorText.replace(new RegExp(h,"gi"),function(a,b,c){return b+e(c)});b!==a.selectorText&&d(a,b)}),f(a))})};return a.rewriteCssSelectorWith=function(a,b,c){h(a,[b],function(){return c})},a.lowercaseCssTypeSelectors=function(a,b){h(a,b,function(a){return a.toLowerCase()})},a.findHtmlOnlyNodeNames=function(a){for(var b,c=a.createTreeWalker(a,NodeFilter.SHOW_ELEMENT),d={},e={};c.nextNode();)b=c.currentNode.tagName.toLowerCase(),"http://www.w3.org/1999/xhtml"===c.currentNode.namespaceURI?d[b]=!0:e[b]=!0;return Object.keys(d).filter(function(a){return!e[a]})},a}(),i=function(a){"use strict";var b={},c=function(a){return Array.prototype.slice.call(a)};return b.fakeHover=function(b,c){var d=b.querySelector(c),e="rasterizehtmlhover";d&&(a.addClassNameRecursively(d,e),a.rewriteCssSelectorWith(b,":hover","."+e))},b.fakeActive=function(b,c){var d=b.querySelector(c),e="rasterizehtmlactive";d&&(a.addClassNameRecursively(d,e),a.rewriteCssSelectorWith(b,":active","."+e))},b.fakeFocus=function(b,c){var d=b.querySelector(c),e="rasterizehtmlfocus";d&&(a.addClassNameRecursively(d,e),a.rewriteCssSelectorWith(b,":focus","."+e))},b.persistInputValues=function(a){var b=a.querySelectorAll("input"),d=a.querySelectorAll("textarea"),e=function(a){return"checkbox"===a.type||"radio"===a.type};c(b).filter(e).forEach(function(a){a.checked?a.setAttribute("checked",""):a.removeAttribute("checked")}),c(b).filter(function(a){return!e(a)}).forEach(function(a){a.setAttribute("value",a.value)}),c(d).forEach(function(a){a.textContent=a.value})},b.rewriteTagNameSelectorsToLowerCase=function(b){a.lowercaseCssTypeSelectors(b,a.findHtmlOnlyNodeNames(b))},b}(h),j=function(a){"use strict";var b,c={},e=function(){var a='<svg id="svg" xmlns="http://www.w3.org/2000/svg" width="10" height="10"><style>@media (max-width: 1em) { svg { background: #00f; } }</style></svg>',b="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(a),c=document.createElement("img");return c.src=b,c},f=function(a,b,c,d){var e=document.createElement("canvas");e.width=a.width,e.height=a.height;var f,g=e.getContext("2d");return g.drawImage(a,0,0),f=g.getImageData(0,0,1,1).data,f[0]===b&&f[1]===c&&f[2]===d},g=function(){var a=e(),b=d.defer();return document.querySelector("body").appendChild(a),a.onload=function(){document.querySelector("body").removeChild(a);try{b.resolve(!f(a,0,0,255))}catch(c){b.resolve(!0)}},a.onerror=function(){b.reject()},b.promise};c.needsEmWorkaround=function(){return void 0===b&&(b=g()),b};var h=function(a){return Array.prototype.slice.call(a)},i=function(a){return h(a).map(function(a){return a.cssText}).join("\n")},j=function(a,b){return"@media "+a.join(", ")+"{"+i(b)+"}"},k=function(a,b,c){try{a.insertRule(c,b+1)}catch(d){return}a.deleteRule(b)},l=function(a,b){var c=a.parentStyleSheet,d=h(c.cssRules).indexOf(a);k(c,d,b)},m=function(a){a.textContent=i(a.sheet.cssRules)},n=function(a){var b=a.modifier?a.modifier+"-"+a.feature:a.feature;return a.value?"("+b+": "+a.value+")":"("+b+")"},o=function(a){var b=[];return a.inverse&&b.push("not"),b.push(a.type),a.expressions.length>0&&b.push("and "+a.expressions.map(n).join(" and ")),b.join(" ")};c.serializeQuery=function(a){var b=a.map(o);return b.join(", ")};var p=function(a){return 16*a},q=function(a){var b=/^((?:\d+\.)?\d+)em/.exec(a);return b?p(parseFloat(b[1]))+"px":a},r=function(b){var d=a.parse(b),e=!1;return d.forEach(function(a){a.expressions.forEach(function(a){var b=q(a.value);e|=b!==a.value,a.value=b})}),e&&(b=c.serializeQuery(d)),b},s=function(a){var b=!1;return a.forEach(function(a){var c=!1,d=h(a.media).map(function(a){var b=r(a);return c|=b!==a,b});c&&l(a,j(d,a.cssRules)),b|=c}),b};return c.workAroundWebKitEmSizeIssue=function(a){var b=a.querySelectorAll("style");h(b).forEach(function(a){var b=h(a.sheet.cssRules).filter(function(a){return a.type===window.CSSRule.MEDIA_RULE}),c=s(b);c&&m(a)})},c}(b),k=function(a,b,c,d){"use strict";var e={},f=function(a,b,c,d){var e=a.createElement(b);return e.style.visibility="hidden",e.style.width=c+"px",e.style.height=d+"px",e.style.position="absolute",e.style.top=-1e4-d+"px",e.style.left=-1e4-c+"px",a.getElementsByTagName("body")[0].appendChild(e),e};e.executeJavascript=function(a,e){var g=f(d.document,"iframe",e.width,e.height),h=a.documentElement.outerHTML,i=[],j=c.defer(),k=e.executeJsTimeout||0,l=function(){var a=g.contentDocument;d.document.getElementsByTagName("body")[0].removeChild(g),j.resolve({document:a,errors:i})},m=function(){var a=c.defer();return k>0?setTimeout(a.resolve,k):a.resolve(),a.promise};g.onload=function(){m().then(o.waitForRequestsToFinish).then(l)};var n=g.contentWindow.XMLHttpRequest,o=b.finishNotifyingXhr(n),p=b.baseUrlRespectingXhr(o,e.baseUrl);return g.contentDocument.open(),g.contentWindow.XMLHttpRequest=p,g.contentWindow.onerror=function(a){i.push({resourceType:"scriptExecution",msg:a})},g.contentDocument.write("<!DOCTYPE html>"),g.contentDocument.write(h),g.contentDocument.close(),j.promise};var g=function(a,b,c){var d=a.createElement("iframe");return d.style.width=b+"px",d.style.height=c+"px",d.style.visibility="hidden",d.style.position="absolute",d.style.top=-1e4-c+"px",d.style.left=-1e4-b+"px",d.sandbox="allow-same-origin",d.scrolling="no",d},h=function(a,b,c){var e=Math.floor(a/c),f=Math.floor(b/c);return g(d.document,e,f)},i=function(a,b,c,d){return{width:Math.max(a.width*d,b),height:Math.max(a.height*d,c)}},j=function(a,b,c,e,f){var g,h,j,k,l,m,n,o,p=Math.max(a.documentElement.scrollWidth,a.body.clientWidth),q=Math.max(a.documentElement.scrollHeight,a.body.scrollHeight,a.body.clientHeight);if(b){if(m=a.querySelector(b),!m)throw{message:"Clipping selector not found"};n=m.getBoundingClientRect(),g=n.top,h=n.left,j=n.width,k=n.height}else g=0,h=0,j=p,k=q;return o=i({width:j,height:k},c,e,f),l=d.getComputedStyle(a.documentElement).fontSize,{left:h,top:g,width:o.width,height:o.height,viewportWidth:p,viewportHeight:q,rootFontSize:l}};e.calculateDocumentContentSize=function(a,b){var e,f=a.documentElement.outerHTML,g=c.defer(),i=b.zoom||1;return e=h(b.width,b.height,i),d.document.getElementsByTagName("body")[0].appendChild(e),e.onload=function(){var a,c=e.contentDocument;try{a=j(c,b.clip,b.width,b.height,i),g.resolve(a)}catch(f){g.reject(f)}finally{d.document.getElementsByTagName("body")[0].removeChild(e)}},e.contentDocument.open(),e.contentDocument.write("<!DOCTYPE html>"),e.contentDocument.write(f),e.contentDocument.close(),g.promise};var k=function(a,b){var c,e,f,g,h=/<html((?:\s+[^>]*)?)>/im.exec(b),i=d.document.implementation.createHTMLDocument("");if(h)for(c="<div"+h[1]+"></div>",i.documentElement.innerHTML=c,f=i.querySelector("div"),e=0;e<f.attributes.length;e++)g=f.attributes[e],a.documentElement.setAttribute(g.name,g.value)};e.parseHTML=function(a){var b=d.document.implementation.createHTMLDocument("");return b.documentElement.innerHTML=a,k(b,a),b};var l=function(a){var b=new DOMParser,c=b.parseFromString("<","text/xml"),d=c.getElementsByTagName("parsererror")[0].namespaceURI;return"http://www.w3.org/1999/xhtml"===d?a.getElementsByTagName("parsererror").length>0:a.getElementsByTagNameNS(d,"parsererror").length>0},m=function(a){if(null===a||l(a))throw{message:"Invalid source"}};e.validateXHTML=function(a){var b=new DOMParser,c=b.parseFromString(a,"application/xml");m(c)};var n=null,o=function(a,b){return"none"===b||"repeated"===b?((null===n||"repeated"!==b)&&(n=Date.now()),a+"?_="+n):a},p=function(b,d){var e=new window.XMLHttpRequest,f=a.joinUrl(d.baseUrl,b),g=o(f,d.cache),h=c.defer(),i=function(){h.reject({message:"Unable to load page"})};e.addEventListener("load",function(){200===e.status||0===e.status?h.resolve(e.responseXML):i()},!1),e.addEventListener("error",function(){i()},!1);try{e.open("GET",g,!0),e.responseType="document",e.send(null)}catch(j){i()}return h.promise};return e.loadDocument=function(a,b){return p(a,b).then(function(a){return m(a),a})},e}(f,g,d,window),l=function(a,b){"use strict";var c,d={},e=function(a,b){return b?URL.createObjectURL(new Blob([a],{type:"image/svg+xml"})):"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(a)},f=function(a){a instanceof Blob&&URL.revokeObjectURL(a)},g='<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"><foreignObject></foreignObject></svg>',h=function(b){var c=document.createElement("canvas"),d=new Image,e=a.defer();return d.onload=function(){var a=c.getContext("2d");try{a.drawImage(d,0,0),c.toDataURL("image/png"),e.resolve(!0)}catch(b){e.resolve(!1)}},d.onerror=e.reject,d.src=b,e.promise},i=function(){var a=e(g,!0);return h(a).then(function(b){return f(a),b?!1:h(e(g,!1)).then(function(a){return a})},function(){return!1})},j=function(){if(b.Blob)try{return new Blob(["<b></b>"],{type:"text/xml"}),!0}catch(a){}return!1},k=function(){var c=a.defer();return j&&b.URL?i().then(function(a){c.resolve(!a)},function(){c.reject()}):c.resolve(!1),c.promise},l=function(){return void 0===c&&(c=k()),c},m=function(a){return l().then(function(b){return e(a,b)})};return d.renderSvg=function(b){var c,d,e=a.defer(),g=function(){d.onload=null,d.onerror=null},h=function(){c&&f(c)};return d=new Image,d.onload=function(){g(),h(),e.resolve(d)},d.onerror=function(){h(),e.reject()},m(b).then(function(a){c=a,d.src=c},e.reject),e.promise},d}(d,window),m=function(a,b,c,d,e){"use strict";var f={},g=function(a,b){var c,d,e,f;b=b||1,c=Math.round(a.viewportWidth),d=Math.round(a.viewportHeight),e=-a.left,f=-a.top;var g={x:e,y:f,width:c,height:d};return 1!==b&&(g.transform="scale("+b+")"),g},h=function(a){var b=a.style||"";a.style=b+"float: left;"},i=function(a){a.externalResourcesRequired=!0},j=function(){return'<style scoped="">html::-webkit-scrollbar { display: none; }</style>'},k=function(a){var b=Object.keys(a);return b.length?" "+b.map(function(b){return b+'="'+a[b]+'"'}).join(" "):""},l=function(a,c,d){var f=e.serializeToString(a);b.validateXHTML(f);var l=g(c,d);return h(l),i(l),'<svg xmlns="http://www.w3.org/2000/svg" width="'+c.width+'" height="'+c.height+'" font-size="'+c.rootFontSize+'">'+j()+"<foreignObject"+k(l)+">"+f+"</foreignObject></svg>"};return f.getSvgForDocument=function(a,b,e){return c.rewriteTagNameSelectorsToLowerCase(a),d.needsEmWorkaround().then(function(c){return c&&d.workAroundWebKitEmSizeIssue(a),l(a,b,e)})},f.drawDocumentAsSvg=function(a,d){return d.hover&&c.fakeHover(a,d.hover),d.active&&c.fakeActive(a,d.active),d.focus&&c.fakeFocus(a,d.focus),b.calculateDocumentContentSize(a,d).then(function(b){return f.getSvgForDocument(a,b,d.zoom)})},f}(f,k,i,j,c),n=function(a,b,c,d,e,f){"use strict";var g={},h=function(){return{message:"Error rendering page"}},i=function(a){return e.renderSvg(a).then(function(b){return{image:b,svg:a}},function(){throw h()})},j=function(a,b){try{b.getContext("2d").drawImage(a,0,0)}catch(c){throw h()}},k=function(a,b,c){return d.drawDocumentAsSvg(a,c).then(i).then(function(a){return b&&j(a.image,b),a})},l=function(a,d){return b.executeJavascript(a,d).then(function(a){var b=a.document;return c.persistInputValues(b),{document:b,errors:a.errors}})};return g.rasterize=function(b,c,d){var e;return e=a.clone(d),e.inlineScripts=d.executeJs===!0,f.inlineReferences(b,e).then(function(a){return d.executeJs?l(b,d).then(function(b){return{document:b.document,errors:a.concat(b.errors)}}):{document:b,errors:a}}).then(function(a){return k(a.document,c,d).then(function(b){return{image:b.image,svg:b.svg,errors:a.errors}})})},g}(f,k,i,m,l,e),o=function(a,b,c){"use strict";var d={},e=function(a,b){var c=300,d=200,e=a?a.width:c,f=a?a.height:d,g=void 0!==b.width?b.width:e,h=void 0!==b.height?b.height:f;return{width:g,height:h}},f=function(b){var c,d=e(b.canvas,b.options);return c=a.clone(b.options),c.width=d.width,c.height=d.height,c};d.drawDocument=function(){var b=arguments[0],d=Array.prototype.slice.call(arguments,1),e=a.parseOptionalParameters(d);return c.rasterize(b,e.canvas,f(e))};var g=function(a,c,e){var f=b.parseHTML(a);return d.drawDocument(f,c,e)};d.drawHTML=function(){var b=arguments[0],c=Array.prototype.slice.call(arguments,1),d=a.parseOptionalParameters(c);return g(b,d.canvas,d.options)};var h=function(b,c,d){var e=document.implementation.createHTMLDocument("");e.replaceChild(b.documentElement,e.documentElement);var f=d?a.clone(d):{};return d.baseUrl||(f.baseUrl=c),{document:e,options:f}},i=function(a,c,e){return b.loadDocument(a,e).then(function(b){var f=h(b,a,e);return d.drawDocument(f.document,c,f.options)})};return d.drawURL=function(){var b=arguments[0],c=Array.prototype.slice.call(arguments,1),d=a.parseOptionalParameters(c);return i(b,d.canvas,d.options)},d}(f,k,n);return o});